@model ArshatidPublic.Models.RegistrationViewModel
@{
    ViewData["Title"] = "Skráning";
    Layout = "_Layout_plain";
}

<p>
    <img src="~/img/CoverPhoto.jpg" class="img-fluid" alt="Event Cover Photo">
</p>

@* Show warning if user is not invited *@
@if (ViewBag.NotInvitedMessage is string notInv && !string.IsNullOrWhiteSpace(notInv))
{
    <div class="alert alert-warning">@notInv</div>
}

@* Otherwise show the form *@
@if (ViewBag.NotInvitedMessage == null)
{
    <div b-191jc0ugh8="" class="container" style="max-width: 1000px;">
        <main b-191jc0ugh8="" role="main" class="pb-3">
            <form asp-controller="Home" asp-action="Skraning" method="post" class="row g-3">
                @Html.AntiForgeryToken()

                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <h3>Heill sé þér @User.Identity.Name</h3>

                <div class="col-12">
                    <div class="form-check">
                        <input class="form-check-input" asp-for="Plus" />
                        <label class="form-check-label" asp-for="Plus"></label>
                    </div>
                </div>

                <div class="col-12">
                    <label class="form-label" for="OrgUnitName">Svið</label>
                    <select class="form-select" id="OrgUnitName" name="OrgUnitName">
                        <option value="">Veldu svið</option>
                        @foreach (string ou in (IEnumerable<string>)ViewBag.OrgUnits)
                        {
                            if (string.Equals(Model.OrgUnitName, ou, StringComparison.Ordinal))
                            {
                                <option value="@ou" selected>@ou</option>
                            }
                            else
                            {
                                <option value="@ou">@ou</option>
                            }
                        }
                    </select>
                </div>

                <div class="col-12">
                    <label class="form-label" for="ArshatidCostCenterFk">Kostnaðarstaður</label>
                    <select class="form-select" id="ArshatidCostCenterFk" name="ArshatidCostCenterFk"></select>
                </div>

                <div class="col-12">
                    <label class="form-label" for="Alergies">Fæðuóþol</label>
                    <textarea class="form-control" id="Alergies" name="Alergies" rows="3">@Model.Alergies</textarea>
                    <span class="text-danger field-validation-valid" data-valmsg-for="Alergies" data-valmsg-replace="true"></span>
                </div>

                <div class="col-12">
                    <div class="form-check">
                        <input class="form-check-input" asp-for="Vegan" />
                        <label class="form-check-label" asp-for="Vegan"></label>
                    </div>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-success me-2">@((ViewBag.HasRegistration ?? false) ? "Breyta" : "Skrá")</button>

                    @* Separate post to Home/KemstEkki, keeping it inline *@
                    @if (ViewBag.HasRegistration ?? false)
                    {
                        <button type="submit"
                                class="btn btn-danger"
                                formaction='@Url.Action("KemstEkki", "Home")'
                                formmethod="post"
                                onclick="return confirm('Ertu alveg viss um að þú getir ekki verið með? Við höfum svo gaman af félagsskap þínum.');">
                            Kemst ekki
                        </button>
                    }
                </div>
            </form>
            <script>
                const costCenters = @Html.Raw(ViewBag.CostCentersJson ?? "[]");
                const orgSelect = document.getElementById('OrgUnitName');
                const ccSelect = document.getElementById('ArshatidCostCenterFk');
                function populateCostCenters() {
                    ccSelect.innerHTML = '';
                    const selectedOrg = orgSelect.value;
                    if (!selectedOrg) return;
                    const filtered = costCenters.filter(c => c.OrgUnitName === selectedOrg);
                    filtered.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.Pk;
                        opt.text = c.CostCenterName;
                        if (@(Model.ArshatidCostCenterFk ?? 0) === c.Pk) {
                            opt.selected = true;
                        }
                        ccSelect.appendChild(opt);
                    });
                }
                orgSelect.addEventListener('change', populateCostCenters);
                document.addEventListener('DOMContentLoaded', function () { populateCostCenters(); });
            </script>
        </main>
    </div>
}
